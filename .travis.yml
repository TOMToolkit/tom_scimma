language: python
python:
- '3.8'
- '3.7'
- '3.6'
os: linux
dist: bionic
cache: pip

before_install:
- sudo apt-get install -y gfortran
- pip uninstall -y numpy
install: pip install -r requirements.txt coverage coveralls
script: coverage run --include=tom_scimma/scimma.py tom_scimma/tests/run_tests.py
after_success: coveralls

env:
  global:
  - secure: Kentw8j/62YQcEQgi39VLT25d8kKGRHRqQczjrCpKsvD0Q/5e3HU95KsM5mqgaExeQkq01bqJaB83mC7CYtOk82HMD+Bo9j1+ZJ9cyNKM3t05gQrsG25JmIvj+uKSvt8CWoi9VYhWXAvqjZ2fSA7w+GBoP4hgq5HzrclmEHebsvcfRtXI1V9vCUEYesVNd31WHX4pJpHZ5SuU39l2ewKWiStN6JLb4HGhryATCgBSEpOKNhhanVWT/8HsGobe2oBQLUCesCYvIChwr1uvI9OX3DtR74IPp07okT37EjtXXjPZQkL8VH2E/+v1IxHSsWLtvAPvkZjoVKMxi2Z+yJ83+i7aiJJtXsz5IFFBqypO0k4a7LX48xjuHskRcJIAtZkr1BhLsjkd0mXXXt68iXP8r3ybIPcGO39avUd5Dmedneiqv2rNX6nM+J36Eol8dj7FprK4cwPgdLqr3hjWtK1SOcts2OpoT2LQZ45csmsa0NOrHHvCNLQgxzXa/LJLjOqnZpKgOSZQyR2wh/yOBHDJQDwqoMTOL80kWDdZ5I6cs6hE0xM36s0mCFQCbyEv+6ws1gvdqayB6I3OroHKvlZ7Z+gatVto1XaUHa8ZRq8gACf6BjnyigfbyYXZR+x3MbpXXqKv+rd4v5IitppH/wlXrQj4UL8NGMYMb01iX5qZWs=
  - secure: ltMhFZUvhBFBn/1DW8vOlL/E+jzfq2LB7RR91ITwPP82l83uhRDeXx/5/DORbVX8VdjaoBF35y8sZLnDpE3MaN/AA40HZjHj/YsUos2BBEOTOhuc38bDsiYmFQopwNjBAmrgZ/nzhBjR4FKcfTzCAjrI0x9H3e6D0VYcIDfev/NQvRTK0wSvy1Ggldwx4rC/2Ise2rfOFvnPZjAsKRw93Yw9SNunlG6qXEc4l6K15/8tBT472kSCn8/0Ft11sDDagwcCLKbmrNvJ3wHJTy8rHITm/pqd3MU0mB12eS909frdn/bWqexg6ACMGVCUIWDUrrfm9NTvli3tFdDA4RHLM7LUU8h0hjqP26R6cYrI/vovUAg8CzoPt6WJyzREmQLIjOZa8+Dajr4vQnwfMOa5w5WkhrT3uqKn2VOxC3RAP5vWI4BrhlpEkRLO7k3g/uGMc5PnvRaLQAz14SN7nwGOI/TWxcmd9GcJvnp5LM/OsCOqoB4/8WJ1Ahj7g3rSEVyNRZa3lALg432yB6YcBBv5KPuhTUt5X0vH5kjD7mj7kY33HBSi1xuXZnwHcOUBME5VfhTCjT9stdZzjFpS78E1THIfXKpwCtkat3p4+cCW9obVrpCX4ZBurB8EuqHp6HS7dwjO+geDIXwBpqqKbavNvcLB+MqPNa0NrUdVN9zn4Ao=

stages:
- Style Checks
- test
- Canary Tests
- Deploy Dev
- Deploy Main

jobs:
  include:
  - stage: Style Checks
    if: type != cron
    install: pip install -I flake8
    script: flake8 tom_* --max-line-length=120
  - stage: Canary Tests
    python: '3.8'
    if: type = cron
    script: python tom_scimma/tests/run_canary_tests.py

  # Deploy alpha releases to PyPi and generate draft release on Github Releases (incomplete)
  - stage: "Deploy Dev"
    if:
    - tag IS present
    - type != cron
    script: skip
    deploy:
      provider: pypi
      skip_existing: true
      cleanup: false
      on:
        branch: dev
        tags: true
        condition: $TRAVIS_TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+\-(alpha)\.[0-9]+$
      username: "__token__"
      password:
         secure: "W11OdJOvj9hvdEsJB48SuPOvylT0awsSG2wScYdtM+mnFx6u5pv7/0oxz0nyhr2/1xD+Mz7QBy5wH2ijXcpruhHwm7loopaB9Lc28au3vnVuDgwdU3yUttXjjzmPHh+q3ggsjAJS7aV4X4CKl0/cM9h3MTsr91MiIvta0cjiPYBTn/3YTrVyO+VypQnsnC2bV7bj1H/c6hYi6mzq4xKtpM1QSMs5baWo7vui1LqbHGeZSID+r9Z3Zx8c8UyAbDG9Qhqi2+TyZxhond1R13IrGtIlvjey87aCnlOFwnA+CXPAbTWsUxq+gE+QO7BCAA2oMZGkLgVeCgHmEHf8gPU/N+XEpdh9FEmgaoU7LIrPOjQI+4ijhEoadhpUxHaQG0j2qhHeE4THz+dfV0XQVPUlzAwX5ZQyLwbAHje8E1wdeqS+pPzodIB18Vtw6Lz0c2ppmieXB1IiSSG0nnxcuLgyFJ/tYJyp63+5fCLK/Itafn3SLT1HRNS/PccbZdUo5L4oFKQsMXgIU9v33Z59CyXpPiNruC+AEwujuEcDrZN1/pYc8+Zmgh42fx+qHZ3/2QitKopl+XMRMnz6X7JIS2QTgY74aLBp/djv5DHtTJnN1cdZ8wMo8K515R/p+C5HboMh9bNEM+imL8pk6Whw9QMGapNoNst99aQz4fUz3n6sPr0="
      distributions: "sdist bdist_wheel"

  - stage: "Deploy Dev"
    if:
    - tag IS present
    - type != cron
    python: 3.8
    script: skip
    deploy:
      provider: releases
      token:
        secure: "V5t/Rk0jK6ggR6Oc2sk6Kr8+mC4vcKD4Vh1/CVhFoB+/QJTJR4wR1ZzdmxSTHVqyYRWMhtbQg4GEenVu3CCE6Aqcpb8FuXagBGDjrydYMvBz0QV0tGpc0QfAGFgihoMxRXYYy8x0qJoImpIgweIcBP6qCIbWlHNn7uSbJgQAcpHI1KP5//SJbiZ5+h1tYa3AImfhuRIjtw5X5XCkbNe04DpJZZrR7et4BnZwjBKmkPBHAoDhfuGzA5PF1S6jHCpWIddhRQ60v6T7yp8jcBEn5yvQSmusfUju61GI0+irFV8LksaWMaLFkxdR2ne8DtHGuXoRs8G/hOLlYZGBMM/JkV2VcuX9F61vspQW2bDrNgAzMEHknYKeTamvt5HV+zYly7X/OnBMAdbDl3ZOjP5h7zYjdeDza+t6dG1+iJKfCjz5dekT20NDVlwJvIMGhqxNOxDRfnlHopoTT/16/Jd7SPDOY2gpDoZxA8uPGZJR52y6T8tZqrR/tamoXRZk5WR4zeIW2rFK85hZwmz59dWQywlhzcIxMHhBcH6r6O3p1NwFA1LPIzgEQHKig/5DxFk52reU70fA9L2nZ1AHSES2RtG9kDQZLx7gbnOaOGx7Jbd6mECFMzliEBKiSnYxN404bNVAoTBEwcuxTho9zJRccQVeIdTD617K4sAqPWWhFwk="
      on:
        branch: dev
        tags: true
      file_glob: true
      file: dist/*
      cleanup: false
      draft: true
      prerelease: true

  # Deploy full releases to PyPi and generate draft release on Github Releases (incomplete)
  - stage: Deploy Main
    if:
    - tag IS present
    - type != cron
    python: 3.8
    script: skip
    deploy:
      provider: pypi
      skip_existing: true
      cleanup: false
      on:
        branch: main
        tags: true
        condition: $TRAVIS_TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+$
      username: "__token__"
      password:
        secure: "W11OdJOvj9hvdEsJB48SuPOvylT0awsSG2wScYdtM+mnFx6u5pv7/0oxz0nyhr2/1xD+Mz7QBy5wH2ijXcpruhHwm7loopaB9Lc28au3vnVuDgwdU3yUttXjjzmPHh+q3ggsjAJS7aV4X4CKl0/cM9h3MTsr91MiIvta0cjiPYBTn/3YTrVyO+VypQnsnC2bV7bj1H/c6hYi6mzq4xKtpM1QSMs5baWo7vui1LqbHGeZSID+r9Z3Zx8c8UyAbDG9Qhqi2+TyZxhond1R13IrGtIlvjey87aCnlOFwnA+CXPAbTWsUxq+gE+QO7BCAA2oMZGkLgVeCgHmEHf8gPU/N+XEpdh9FEmgaoU7LIrPOjQI+4ijhEoadhpUxHaQG0j2qhHeE4THz+dfV0XQVPUlzAwX5ZQyLwbAHje8E1wdeqS+pPzodIB18Vtw6Lz0c2ppmieXB1IiSSG0nnxcuLgyFJ/tYJyp63+5fCLK/Itafn3SLT1HRNS/PccbZdUo5L4oFKQsMXgIU9v33Z59CyXpPiNruC+AEwujuEcDrZN1/pYc8+Zmgh42fx+qHZ3/2QitKopl+XMRMnz6X7JIS2QTgY74aLBp/djv5DHtTJnN1cdZ8wMo8K515R/p+C5HboMh9bNEM+imL8pk6Whw9QMGapNoNst99aQz4fUz3n6sPr0="
      distributions: "sdist bdist_wheel"

  - stage: Deploy Main
    if:
    - tag IS present
    - type != cron
    python: 3.8
    script: skip
    deploy:
      provider: releases
      token:
        secure: "V5t/Rk0jK6ggR6Oc2sk6Kr8+mC4vcKD4Vh1/CVhFoB+/QJTJR4wR1ZzdmxSTHVqyYRWMhtbQg4GEenVu3CCE6Aqcpb8FuXagBGDjrydYMvBz0QV0tGpc0QfAGFgihoMxRXYYy8x0qJoImpIgweIcBP6qCIbWlHNn7uSbJgQAcpHI1KP5//SJbiZ5+h1tYa3AImfhuRIjtw5X5XCkbNe04DpJZZrR7et4BnZwjBKmkPBHAoDhfuGzA5PF1S6jHCpWIddhRQ60v6T7yp8jcBEn5yvQSmusfUju61GI0+irFV8LksaWMaLFkxdR2ne8DtHGuXoRs8G/hOLlYZGBMM/JkV2VcuX9F61vspQW2bDrNgAzMEHknYKeTamvt5HV+zYly7X/OnBMAdbDl3ZOjP5h7zYjdeDza+t6dG1+iJKfCjz5dekT20NDVlwJvIMGhqxNOxDRfnlHopoTT/16/Jd7SPDOY2gpDoZxA8uPGZJR52y6T8tZqrR/tamoXRZk5WR4zeIW2rFK85hZwmz59dWQywlhzcIxMHhBcH6r6O3p1NwFA1LPIzgEQHKig/5DxFk52reU70fA9L2nZ1AHSES2RtG9kDQZLx7gbnOaOGx7Jbd6mECFMzliEBKiSnYxN404bNVAoTBEwcuxTho9zJRccQVeIdTD617K4sAqPWWhFwk="
      on:
        branch: main
        tags: true
      file_glob: true
      file: dist/*
      cleanup: false
      draft: true
